// Prisma Schema for Qeematech Educational Platform
// Using MySQL database with JWT Authentication

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model School {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String   // Hashed password
  phone     String?
  address   String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  

  students Student[]
  lessons  Lesson[]
  refreshTokens RefreshToken[]
}

model Student {
  id           Int        @id @default(autoincrement())
  name         String
  email        String     @unique
  password     String     // Hashed password
  phone        String?
  profileImage String?
  class        String?
  academicYear String?
  schoolId     Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  favorites Favorite[]
  refreshTokens RefreshToken[]
}

model Lesson {
  id          Int        @id @default(autoincrement())
  name        String
  description String?    @db.Text
  image       String?
  rating      Float      @default(0)
  schoolId    Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  favorites Favorite[]
}

model Favorite {
  id        Int      @id @default(autoincrement())
  studentId Int
  lessonId  Int
  createdAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([studentId, lessonId])
}

model RefreshToken {
  id            Int      @id @default(autoincrement())
  token         String   @unique @db.VarChar(500)
  userId        Int
  userType      String   // 'student' or 'admin'
  expiresAt     DateTime
  revoked       Boolean  @default(false)
  replacedBy    String?  // The new token that replaced this one
  createdAt     DateTime @default(now())

  // Relations
  student       Student? @relation(fields: [userId], references: [id], onDelete: Cascade, map: "student_token")
  school        School?  @relation(fields: [userId], references: [id], onDelete: Cascade, map: "school_token")

  @@index([userId, userType])
}
